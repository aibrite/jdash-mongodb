"use strict";var mongoose=require("mongoose"),dashlet_1=require("./db/dashlet"),dashboard_1=require("./db/dashboard"),MongoDbProvider=function(){function t(t){this.options=t,this.connection=t.connection,this.dashboardModel=dashboard_1.default(this.connection),this.dashletModel=dashlet_1.default(this.connection)}return t.prototype.dashDocumentToDashModel=function(t){return{config:t.config,description:t.description,id:t._id.toString(),layout:t.layout,title:t.title,shareWith:t.shareWith}},t.prototype.dashletDocumentToModel=function(t){return{configuration:t.configuration,dashboardId:t.dashboardId,description:t.description,id:t._id.toString(),moduleId:t.moduleId,title:t.title}},t.prototype.searchDashboards=function(t,e){var o=this;e=e||{limit:100,startFrom:0},e.limit=Math.min(e.limit,100),t=t||{},t.appid&&(t.appid="string"==typeof t.appid?[t.appid]:t.appid),t.user&&(t.user="string"==typeof t.user?[t.user]:t.user),t.shareWith&&(t.shareWith="string"==typeof t.shareWith?[t.shareWith]:t.shareWith);var r={};return t.appid&&(r.appid={$in:t.appid}),t.user&&(r.user={$in:t.user}),this.dashboardModel.find(r).sort({createdAt:-1}).skip(e.startFrom).limit(e.limit+1).then(function(t){var r=t.map(o.dashDocumentToDashModel),i=!1;return r.length>e.limit&&(i=!0,r.splice(r.length-1,1)),{data:r,hasMore:i}})},t.prototype.getDashboard=function(t,e){var o=this;return this.dashboardModel.findOne({_id:e,appid:t}).then(function(t){var e=o.dashDocumentToDashModel(t);return o.searchDashlets({dashboardId:e.id}).then(function(t){return{dashboard:e,dashlets:t}})})},t.prototype.createDashboard=function(t){var e={appid:t.appid,title:t.title,shareWith:t.shareWith,description:t.description,user:t.user,createdAt:t.createdAt,config:t.config||{},layout:t.layout};return this.dashboardModel.create(e).then(function(t){return{id:t._id.toString()}})},t.prototype.deleteDashboard=function(t,e){return this.dashboardModel.findOne({_id:e,appid:t}).then(function(t){return t.remove()})},t.prototype.updateDashboard=function(t,e,o){return this.dashboardModel.findOne({_id:e,appid:t}).then(function(t){return Object.keys(o).forEach(function(e){t[e]=o[e]}),t.save()})},t.prototype.createDashlet=function(t){var e={dashboardId:t.dashboardId,configuration:t.configuration||{},moduleId:t.moduleId,title:t.title,description:t.description,createdAt:t.createdAt};return this.dashletModel.create(e).then(function(t){return{id:t._id.toString()}})},t.prototype.searchDashlets=function(t){var e=this,o={dashboardId:t.dashboardId,user:{}};return t.user instanceof Array?o.user={$in:t.user}:o.user=t.user,this.dashletModel.find(o).then(function(t){return t.map(e.dashletDocumentToModel)})},t.prototype.deleteDashlet=function(t){return this.dashletModel.findById(t).then(function(t){return t.remove()})},t.prototype.updateDashlet=function(t,e){return this.dashletModel.findById(t).then(function(t){return Object.keys(e).forEach(function(o){t[o]=e[o]}),t.save()})},t}();exports.MongoDbProvider=MongoDbProvider,mongoose.Promise=global.Promise,Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(t){return new MongoDbProvider(t)};